<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CabaTech å£²ä¸Šãƒ»çµŒè²»ç®¡ç†ãƒ„ãƒ¼ãƒ«ï¼ˆãƒ‡ãƒ¢ç‰ˆï¼‰</title>
    <!-- Tailwind CSS CDNã‚’ãƒ­ãƒ¼ãƒ‰ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        body { font-family: 'Inter', sans-serif; }
        .form-section {
            @apply p-4 bg-gray-700 rounded-lg shadow-inner;
        }
        .section-header {
            @apply text-lg font-semibold text-teal-400 border-b border-gray-600 pb-2 mb-3;
        }
        
        /* ğŸ’¡ å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«: æ–‡å­—è‰²ã‚’ãƒ†ã‚£ãƒ¼ãƒ«ç³»ã®æ˜ã‚‹ã„è‰²ã«å¤‰æ›´ (text-white/gray-200ã‚’å›é¿) */
        .input-style {
            @apply w-full p-2 border border-gray-600 bg-gray-800 rounded-md 
                   text-teal-200 placeholder-gray-500 
                   focus:ring-teal-500 focus:border-teal-500 
                   transition duration-150 disabled:opacity-70; 
        }
        .radio-checked {
            @apply ring-2 ring-teal-500 bg-teal-600;
        }
        
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 sm:p-8 flex flex-col items-center">

    <div class="w-full max-w-lg bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl space-y-6">
        <h2 class="text-3xl font-extrabold text-center text-teal-400">CabaTech å£²ä¸Šãƒ»çµŒè²»ç®¡ç†ãƒ„ãƒ¼ãƒ«</h2>

        <!-- æœ€çµ‚æ›´æ–°æ—¥æ™‚ - ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®é™çš„æ—¥ä»˜ã§è¡¨ç¤º -->
        <div id="last-updated" class="text-xs text-gray-500 text-right">æœ€çµ‚æ›´æ–°: 2025/12/02 15:53:40</div>
        
        <!-- ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠ -->
        <form id="main-form" class="space-y-6">
            
            <!-- 1. ã‚«ãƒ†ã‚´ãƒªé¸æŠ (type) -->
            <div id="type-section" class="form-section space-y-3">
                <!-- text-gray-300 -> text-gray-400 ã«ä¿®æ­£ -->
                <p class="text-sm font-medium text-gray-400">è¨˜éŒ²ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ (type):</p>
                <div class="flex space-x-4">
                    <!-- text-gray-300 -> text-gray-400 ã«ä¿®æ­£ -->
                    <label class="flex items-center text-gray-400 cursor-pointer p-2 rounded-lg hover:bg-gray-600 transition">
                        <input type="radio" name="type" value="å£²ä¸Šãƒ»æ³¨æ–‡" 
                               class="text-teal-500 focus:ring-teal-500 h-4 w-4 border-gray-300" 
                               onchange="handleTypeChange(this.value)" checked>
                        <span class="ml-2 text-sm font-medium">å£²ä¸Šãƒ»æ³¨æ–‡</span>
                    </label>
                    <!-- text-gray-300 -> text-gray-400 ã«ä¿®æ­£ -->
                    <label class="flex items-center text-gray-400 cursor-pointer p-2 rounded-lg hover:bg-gray-600 transition">
                        <input type="radio" name="type" value="çµŒè²»" 
                               class="text-teal-500 focus:ring-teal-500 h-4 w-4 border-gray-300" 
                               onchange="handleTypeChange(this.value)">
                        <span class="ml-2 text-sm font-medium">çµŒè²»</span>
                    </label>
                </div>
            </div>

            <!-- 2. æ‹…å½“è€…/ã‚­ãƒ£ã‚¹ãƒˆåå…¥åŠ› (q2) -->
            <div id="q2-section" class="form-section space-y-1">
                <!-- text-gray-300 -> text-gray-400 ã«ä¿®æ­£ -->
                <label for="q2" class="block text-sm font-medium text-gray-400">æ‹…å½“è€…å (q2): <span class="text-red-400">*</span></label>
                <!-- input-style ã‚’é©ç”¨ (å†…éƒ¨ã¯ text-teal-200) -->
                <input type="text" id="q2" name="q2" class="input-style" placeholder="ä¾‹: å¤ªéƒ">
            </div>

            <!-- 3. å£²ä¸Šãƒ»æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ  (q3) - åˆæœŸè¡¨ç¤º -->
            <div id="q3-section" class="form-section space-y-3">
                <h3 class="section-header">å£²ä¸Šãƒ»æ³¨æ–‡é …ç›® (q3)</h3>
                <div id="sales-items-container" class="space-y-3">
                    <p class="text-sm text-gray-400">æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...</p>
                </div>
            </div>

            <!-- 4. çµŒè²»ãƒ•ã‚©ãƒ¼ãƒ  (q5) - åˆæœŸéè¡¨ç¤º -->
            <div id="q5-section" class="form-section space-y-3 hidden">
                <h3 class="section-header">çµŒè²»é …ç›® (q5)</h3>
                <div id="expense-items-container" class="space-y-4">
                    <p class="text-sm text-gray-400">çµŒè²»å®šç¾©ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...</p>
                </div>
                
                <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div id="expense-debug-info" class="p-2 bg-gray-900 border border-gray-700 rounded-md text-xs text-gray-400 mt-4">
                    <!-- GASã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸçµŒè²»ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
            
            <!-- 5. é€ä¿¡ãƒœã‚¿ãƒ³ -->
            <button type="submit"
                    class="w-full py-3 bg-teal-600 hover:bg-teal-500 text-white font-semibold rounded-lg shadow-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50 transform hover:scale-[1.01]">
                ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡ãƒ»è¨˜éŒ²
            </button>
        </form>

        <!-- 6. åˆ†æãƒšãƒ¼ã‚¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ (q7) -->
        <div class="form-section space-y-3 border-t border-gray-700 pt-4">
            <!-- text-gray-300 -> text-gray-400 ã«ä¿®æ­£ -->
            <h3 class="text-base font-bold text-gray-400">åˆ†æãƒšãƒ¼ã‚¸ã¸ç§»å‹• (q7)</h3>
            <p class="text-xs text-gray-400">ã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            <div class="flex space-x-3">
                <!-- input-style ã‚’é©ç”¨ (å†…éƒ¨ã¯ text-teal-200) -->
                <input type="password" id="q7" name="q7" class="input-style flex-grow" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                <button onclick="attemptRedirect()"
                        class="py-2 px-4 bg-orange-600 hover:bg-orange-500 text-white text-sm font-medium rounded-md transition duration-200 focus:outline-none focus:ring-2 focus:ring-orange-500">
                    åˆ†æãƒšãƒ¼ã‚¸ã¸
                </button>
            </div>
            <div id="redirect-result" class="text-xs text-red-400 min-h-4"></div>
        </div>

        <!-- 7. ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡çµæœ -->
        <!-- text-white -> text-teal-200 ã«ä¿®æ­£ -->
        <div id="result" class="mt-4 p-4 text-sm font-medium rounded-lg text-center min-h-10 transition duration-300 text-teal-200">
            <!-- çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
    </div>

    <script>
        // ğŸ’¡ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰æä¾›ã•ã‚ŒãŸæ­£ã—ã„URLã«ä¿®æ­£
        const CORRECT_GAS_API_URL = "https://script.google.com/macros/s/AKfycbwm1cN_jcDzR3YJLVnf6kCYCMGrHuKJ6-NYjV6rUR2GX_DBcaLFcICjebVdRN9f7Hu1_A/exec"; 
        
        /**
         * ç¾åœ¨ä½¿ç”¨ã™ã¹ãGASã®URLã‚’å–å¾—ã™ã‚‹
         */
        function getGasApiUrl() {
            return CORRECT_GAS_API_URL;
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢
        let AppData = {
            formDef: [],
            orders: [], 
            expenseDefs: [], 
            depMap: {},
            setVal: '' 
        };
        
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸå‡¦ç†
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('main-form').addEventListener('submit', (e) => {
                e.preventDefault();
                submitFormData();
            });
            
            loadAllData();
        });


        /**
         * GASã‹ã‚‰å…¨ã¦ã®ãƒ•ã‚©ãƒ¼ãƒ å®šç¾©ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆçš„ã«å–å¾—ã™ã‚‹
         */
        async function loadAllData() {
            const GAS_API_URL = getGasApiUrl(); // URLã‚’å–å¾—
            const salesContainer = document.getElementById('sales-items-container');
            const expenseContainer = document.getElementById('expense-items-container');
            const resultDiv = document.getElementById('result');

            salesContainer.innerHTML = '<p class="text-sm text-gray-400">æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...</p>';
            expenseContainer.innerHTML = '<p class="text-sm text-gray-400">çµŒè²»å®šç¾©ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...</p>';
            resultDiv.className = 'hidden';

            let dataLoadedFromGAS = false;
            const MAX_RETRIES = 3;
            let lastError = null;

            for (let i = 0; i < MAX_RETRIES; i++) {
                let responseText = '';
                try {
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ã—ã€æ–°ã—ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å¼·åˆ¶ã™ã‚‹
                    const response = await fetch(GAS_API_URL + "?action=loadData", {
                        method: 'GET', 
                        cache: 'no-store' 
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    responseText = await response.text();
                    let data;

                    if (responseText.trim().startsWith('<!DOCTYPE html>') || responseText.trim().startsWith('<html')) {
                        console.error('GAS returned HTML (likely an error page):', responseText);
                        throw new Error('GAS_RETURNED_HTML');
                    }

                    try {
                        data = JSON.parse(responseText);
                    } catch (e) {
                        const preview = responseText.substring(0, 200) + (responseText.length > 200 ? '...' : ''); 
                        console.error('JSON Parse failed on received text (GAS returned non-JSON text). Full response:', responseText);
                        throw new Error(`JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: å—ä¿¡ãƒ‡ãƒ¼ã‚¿ãŒJSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å…ˆé ­: "${preview}"`);
                    }
                    
                    if (data.status === 'error') {
                        throw new Error(`GASã‚¨ãƒ©ãƒ¼: ${data.message || 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'}`);
                    }
                    
                    // æˆåŠŸã—ãŸå ´åˆã€AppDataã‚’GASãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ã
                    AppData.orders = data.orders || [];
                    AppData.expenseDefs = data.expenseDefs || [];
                    AppData.setVal = data.setVal || '';
                    dataLoadedFromGAS = true;
                    
                    console.log("âœ… GASã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’æ­£å¸¸ã«ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚");
                    break; 
                    
                } catch (error) {
                    lastError = error;
                    if (i < MAX_RETRIES - 1) {
                        const delay = Math.pow(2, i) * 100; // ãƒªãƒˆãƒ©ã‚¤ã‚’æ—©ãã™ã‚‹
                        console.log(`[API Retry] Attempt ${i + 1} failed. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }


            // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ãŒå¤±æ•—ã—ãŸå ´åˆã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã—ã€ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã§ç¶šè¡Œ
            if (!dataLoadedFromGAS) {
                console.warn('âš ï¸ GASã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚');
                
                // lastErrorã®è©³ç´°ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã—ã€ç”»é¢è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª¿æ•´
                console.error('[CONSOLE_ERROR] æœ€çµ‚çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', lastError);

                let errorMessage = '';
                if (lastError && lastError.message) {
                    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é–¢é€£ã®ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡º
                    const networkError = lastError.message.includes('Failed to fetch') || lastError.message.includes('Type error');
                    errorMessage = networkError 
                        ? `ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚¨ãƒ©ãƒ¼ï¼ˆURL/CORSã®å•é¡Œï¼‰ã€‚`
                        : lastError.message;
                } else {
                    errorMessage = 'æ¥ç¶šã¾ãŸã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é–¢é€£ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                }

                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’lastErrorã‹ã‚‰å–å¾—ã—ã€ç”»é¢ã«è¡¨ç¤º
                let displayMessage = `âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰å¤±æ•— (${MAX_RETRIES}å›å†è©¦è¡Œå¾Œ): ${errorMessage}
                                      ä½¿ç”¨URL: ${GAS_API_URL}
                                      GASã®URLãŒæ­£ã—ã„ã‹ã€ãƒ‡ãƒ—ãƒ­ã‚¤ç‰ˆã®**å…¬é–‹è¨­å®šï¼ˆã€Œå…¨å“¡ã€ï¼‰**ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã§å®Ÿè¡Œä¸­ã€‚`;
                
                resultDiv.textContent = displayMessage;
                resultDiv.className = 'mt-4 p-4 text-sm font-medium rounded-lg text-center bg-red-900 text-red-300';

                // --- ã“ã“ã§ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å¼·åˆ¶çš„ã«è¨­å®šã™ã‚‹ ---
                AppData.orders = [
                    { key: 'ãƒ“ãƒ¼ãƒ« (å¤§)', price: 800, qty: 1 },
                    { key: 'ãƒœãƒˆãƒ« (èµ¤)', price: 5000, qty: 1 },
                    { key: 'ã‚·ãƒ§ãƒƒãƒˆ', price: 1000, qty: 3 },
                    { key: 'ãƒ•ãƒ¼ãƒ‰', price: 1500, qty: 1 }
                ];
                AppData.expenseDefs = [
                    {
                        key: 'é›‘è²»',
                        col2: { header: 'è©³ç´°', type: 'text', initialValue: 'å‚™å“è³¼å…¥' },
                        col3: { header: 'é‡‘é¡', type: 'number', initialValue: 500 }
                    },
                    {
                        key: 'äº¤é€šè²»',
                        col2: { header: 'è¡Œå…ˆ', type: 'text', initialValue: 'è‡ªå®…' },
                        col3: { header: 'é‡‘é¡', type: 'number', initialValue: 1200 }
                    },
                    {
                        key: 'ãã®ä»–',
                        col2: { header: 'è©³ç´°', type: 'text', initialValue: '' },
                        col3: { header: 'é‡‘é¡', type: 'number', initialValue: 0 }
                    }
                ];
                AppData.setVal = 'cabatech_pass';
                // ------------------------------------------

            } else {
                 resultDiv.className = 'hidden'; // æˆåŠŸæ™‚ã¯éè¡¨ç¤º
            }

            // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            renderSalesItems();
            renderExpenseItems();
            handleTypeChange('å£²ä¸Šãƒ»æ³¨æ–‡'); // åˆæœŸã‚«ãƒ†ã‚´ãƒªã®è¡¨ç¤º
        }

        /**
         * å£²ä¸Šãƒ»æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ  (q3) ã‚’å‹•çš„ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
         */
        function renderSalesItems() {
            const container = document.getElementById('sales-items-container');
            if (AppData.orders.length === 0) {
                container.innerHTML = '<p class="text-sm text-yellow-400">æ³¨æ–‡é …ç›®ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
                return;
            }

            const itemsHtml = AppData.orders.map(order => `
                <div class="flex items-center space-x-3 p-2 bg-gray-600 rounded-md">
                    <!-- ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ (q3) -->
                    <!-- text-gray-200 -> text-teal-200 ã«ä¿®æ­£ -->
                    <label class="flex items-center flex-grow text-sm text-teal-200 cursor-pointer">
                        <input type="checkbox" name="q3" value="${order.key}" 
                               class="text-teal-500 focus:ring-teal-500 h-4 w-4 border-gray-400 rounded"
                               onchange="toggleQtyInput('${order.key}', this.checked)">
                        <span class="ml-2 font-medium">${order.key} (${new Intl.NumberFormat('ja-JP').format(order.price)}å††)</span>
                    </label>
                    
                    <!-- æ•°é‡å…¥åŠ› (q3_qty_...) -->
                    <!-- å†…éƒ¨ãƒ•ã‚©ãƒ³ãƒˆã¯ text-teal-200 -->
                    <input type="number" 
                           id="q3_qty_${order.key}" 
                           name="q3_qty_${order.key}" 
                           value="${order.qty}" 
                           min="0" 
                           placeholder="æ•°é‡" 
                           class="w-20 p-1 text-sm text-center border border-gray-500 bg-gray-700 rounded-md text-teal-200 disabled:opacity-70">
                </div>
            `).join('');

            container.innerHTML = `
                <p class="text-xs text-gray-400 mb-2">ãƒã‚§ãƒƒã‚¯ã—ãŸé …ç›®ã‚’å£²ä¸Šã¨ã—ã¦è¨˜éŒ²ã—ã¾ã™ã€‚</p>
                <input type="hidden" name="q3" value=""> <!-- é¸æŠãŒãªã„å ´åˆã«å‚™ãˆãŸãƒ€ãƒŸãƒ¼ -->
                ${itemsHtml}
            `;
            
            // ãƒ­ãƒ¼ãƒ‰å¾Œã€å…¨ã¦ã®æ•°é‡å…¥åŠ›ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã«æˆ»ã™
            AppData.orders.forEach(order => toggleQtyInput(order.key, false));
        }
        
        /**
         * q3ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«å¿œã˜ã¦æ•°é‡å…¥åŠ›ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
         */
        function toggleQtyInput(key, isChecked) {
            const qtyInput = document.getElementById(`q3_qty_${key}`);
            if (qtyInput) {
                qtyInput.disabled = !isChecked;
                // ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸã‚‰æ•°é‡ã‚’åˆæœŸå€¤ã«æˆ»ã™ã‹ã€1ã«ã™ã‚‹
                if (isChecked) {
                   qtyInput.value = AppData.orders.find(o => o.key === key)?.qty || 1;
                } else {
                   qtyInput.value = 0; // ãƒã‚§ãƒƒã‚¯è§£é™¤æ™‚ã¯0ã«ãƒªã‚»ãƒƒãƒˆ
                }
            }
        }


        /**
         * çµŒè²»ã‚¢ã‚¤ãƒ†ãƒ  (q5) ã‚’å‹•çš„ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
         */
        function renderExpenseItems() {
            const container = document.getElementById('expense-items-container');
            const debugInfo = document.getElementById('expense-debug-info'); 

            if (AppData.expenseDefs.length === 0) {
                container.innerHTML = '<p class="text-sm text-yellow-400">çµŒè²»é …ç›®ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
                debugInfo.innerHTML = '<p>ãƒ‡ãƒãƒƒã‚°æƒ…å ±: çµŒè²»å®šç¾©ãƒ‡ãƒ¼ã‚¿ã¯ç©ºã§ã™ã€‚GASã®ã‚·ãƒ¼ãƒˆåã‚„SPREADSHEET_IDã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>';
                return;
            }

            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã«å‡ºåŠ›
            debugInfo.innerHTML = `
                <p class="font-bold text-teal-400 mb-1">--- çµŒè²»ãƒ‡ãƒ¼ã‚¿å®šç¾© (GASã‹ã‚‰ã®å—ä¿¡ãƒ‡ãƒ¼ã‚¿) ---</p>
                ${AppData.expenseDefs.map(def => 
                    `<p><strong>${def.key}</strong>: 
                     [col2: H:${def.col2?.header || 'N/A'}/T:${def.col2?.type || 'N/A'}/V:${def.col2?.initialValue || 'N/A'}] 
                     [col3: H:${def.col3?.header || 'N/A'}/T:${def.col3?.type || 'N/A'}/V:${def.col3?.initialValue || 'N/A'}]</p>`
                ).join('')}
                <p class="mt-1">â€» T: type (å…¥åŠ›ã‚¿ã‚¤ãƒ—), H: header, V: initialValue</p>
            `;


            const itemsHtml = AppData.expenseDefs.map(def => {
                const type2 = typeof def.col2?.type === 'string' ? def.col2.type.toLowerCase() : '';
                const type3 = typeof def.col3?.type === 'string' ? def.col3.type.toLowerCase() : '';

                const col2InputType = (type2 === 'number' || type2 === 'n') ? 'number' : 'text';
                const col3InputType = (type3 === 'number' || type3 === 'n') ? 'number' : 'text';

                return `
                    <div class="space-y-2 p-3 border border-gray-600 rounded-lg">
                        <!-- text-gray-200 -> text-teal-200 ã«ä¿®æ­£ -->
                        <label class="flex items-center text-sm font-medium text-teal-200 cursor-pointer">
                            <input type="checkbox" name="q5_items" value="${def.key}" 
                                   class="text-teal-500 focus:ring-teal-500 h-4 w-4 border-gray-400 rounded"
                                   onchange="toggleExpenseInputs('${def.key}', this.checked)">
                            <span class="ml-2">${def.key}</span>
                        </label>
                        
                        <div id="expense_details_${def.key}" class="flex space-x-3 mt-1 transition duration-200">
                            <!-- col2 (ä¾¡æ ¼/è©³ç´°) -->
                            <div class="flex-1">
                                <label for="expense_${def.key}_col2" class="block text-xs text-gray-400 mb-1">${def.col2.header}</label>
                                <!-- input-style ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ (å†…éƒ¨ã¯ text-teal-200) -->
                                <input type="${col2InputType}" 
                                       id="expense_${def.key}_col2" 
                                       name="expense_${def.key}_col2" 
                                       placeholder="${def.col2.header}"
                                       value="${def.col2.initialValue}" 
                                       class="input-style p-1 text-sm">
                            </div>

                            <!-- col3 (å€‹æ•°/é‡‘é¡) -->
                            <div class="flex-1">
                                <label for="expense_${def.key}_col3" class="block text-xs text-gray-400 mb-1">${def.col3.header}</label>
                                <!-- input-style ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ (å†…éƒ¨ã¯ text-teal-200) -->
                                <input type="${col3InputType}" 
                                       id="expense_${def.key}_col3" 
                                       name="expense_${def.key}_col3" 
                                       placeholder="${def.col3.header}"
                                       value="${def.col3.initialValue}" 
                                       class="input-style p-1 text-sm">
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <p class="text-xs text-gray-400 mb-2">ãƒã‚§ãƒƒã‚¯ã—ãŸçµŒè²»é …ç›®ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚</p>
                <input type="hidden" name="q5_items" value=""> <!-- é¸æŠãŒãªã„å ´åˆã«å‚™ãˆãŸãƒ€ãƒŸãƒ¼ -->
                ${itemsHtml}
            `;
            
            // åˆæœŸã®çŠ¶æ…‹ã‚’è¨­å®š 
            AppData.expenseDefs.forEach(def => toggleExpenseInputs(def.key, false));
        }

        /**
         * q5ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«å¿œã˜ã¦çµŒè²»è©³ç´°å…¥åŠ›ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
         */
        function toggleExpenseInputs(key, isChecked) {
            const detailsDiv = document.getElementById(`expense_details_${key}`);
            if (!detailsDiv) return;

            // detailsDivå…¨ä½“ã‚’éæ“ä½œçŠ¶æ…‹ã«ã™ã‚‹ï¼ˆã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’é®æ–­ï¼‰
            if (isChecked) {
                detailsDiv.classList.remove('pointer-events-none');
            } else {
                detailsDiv.classList.add('pointer-events-none');
            }
            
            // å­è¦ç´ ã®å…¥åŠ›æ¬„ã‚’å–å¾—
            const col2 = document.getElementById(`expense_${key}_col2`);
            const col3 = document.getElementById(`expense_${key}_col3`);

            if (col2) {
                col2.disabled = !isChecked; // disabledå±æ€§ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
                // ãƒã‚§ãƒƒã‚¯OFFæ™‚ã¯å€¤ã‚’ãƒªã‚»ãƒƒãƒˆ
                if (!isChecked) col2.value = AppData.expenseDefs.find(d => d.key === key)?.col2.initialValue || '';
            }
            if (col3) {
                col3.disabled = !isChecked; // disabledå±æ€§ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
                // ãƒã‚§ãƒƒã‚¯OFFæ™‚ã¯å€¤ã‚’ãƒªã‚»ãƒƒãƒˆ
                if (!isChecked) col3.value = AppData.expenseDefs.find(d => d.key === key)?.col3.initialValue || '';
            }
        }
        
        /**
         * ã‚¿ã‚¤ãƒ— (å£²ä¸Šãƒ»çµŒè²») ã®é¸æŠã«å¿œã˜ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
         */
        function handleTypeChange(type) {
            const q3Section = document.getElementById('q3-section');
            const q5Section = document.getElementById('q5-section');

            if (type === 'å£²ä¸Šãƒ»æ³¨æ–‡') {
                q3Section.classList.remove('hidden');
                q5Section.classList.add('hidden');
            } else if (type === 'çµŒè²»') {
                q3Section.classList.add('hidden');
                q5Section.classList.remove('hidden');
            }
        }


        /**
         * ãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿é€ä¿¡å‡¦ç† (GASã®submitFormã‚’å©ã)
         */
        async function submitFormData() {
            const GAS_API_URL = getGasApiUrl(); // URLã‚’å–å¾—
            const resultDiv = document.getElementById('result');
            // text-white -> text-teal-200 ã«ä¿®æ­£
            resultDiv.className = 'mt-4 p-4 text-sm font-medium rounded-lg text-center bg-gray-700 text-teal-200';
            resultDiv.textContent = 'é€ä¿¡ä¸­...';

            const form = document.getElementById('main-form');
            const formData = new FormData();
            
            // å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯
            const type = document.querySelector('input[name="type"]:checked')?.value;
            const q2Value = document.getElementById('q2').value.trim();

            if (!q2Value) {
                resultDiv.textContent = 'âŒ æ‹…å½“è€…å (q2) ã¯å¿…é ˆã§ã™ã€‚';
                resultDiv.className = 'mt-4 p-4 text-sm font-medium rounded-lg text-center bg-red-900 text-red-300';
                document.getElementById('q2').focus();
                return;
            }

            formData.append('id', 'anonymous_user');
            formData.append('pass', 'none');
            
            formData.append('type', 'write'); 
            formData.append('category', type); 
            formData.append('q2', q2Value);
            
            form.querySelectorAll('input, select, textarea').forEach(element => {
                if (element.name && element.name !== 'type') {
                    if (element.type === 'checkbox' || element.type === 'radio') {
                        if (element.checked) {
                            if (element.name === 'q3') {
                                formData.append('q3', element.value);
                            } else if (element.name === 'q5_items') {
                                formData.append('q5', element.value);
                            }
                        }
                    } else if (!element.disabled && element.type !== 'submit') {
                        // disabledå±æ€§ãŒãªã„ã€ã‹ã¤submitãƒœã‚¿ãƒ³ã§ãªã„è¦ç´ ã®å€¤ã‚’è¿½åŠ 
                        formData.append(element.name, element.value);
                    }
                }
            });

            // æœ€çµ‚é€ä¿¡
            try {
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ã—ã€æ–°ã—ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å¼·åˆ¶ã™ã‚‹
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: formData,
                    cache: 'no-store'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const responseText = await response.text();
                let data;

                if (responseText.trim().startsWith('<!DOCTYPE html>') || responseText.trim().startsWith('<html')) {
                    console.error('GAS returned HTML (likely an error page):', responseText);
                    throw new Error('GAS_RETURNED_HTML'); 
                }

                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error('JSON Parse failed on received text (GAS returned non-JSON text):', responseText);
                    throw new Error('JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: å—ä¿¡ãƒ‡ãƒ¼ã‚¿ãŒJSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
                }
                
                if (data.status === 'success') {
                    resultDiv.textContent = 'âœ… è¨˜éŒ²æˆåŠŸï¼ãƒ‡ãƒ¼ã‚¿ã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«é€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚';
                    resultDiv.className = 'mt-4 p-4 text-sm font-medium rounded-lg text-center bg-green-900 text-green-300';
                } else {
                    throw new Error(`GASã‚¨ãƒ©ãƒ¼: ${data.message || 'è¨˜éŒ²å¤±æ•—ã€‚'}`);
                }
                
                form.reset();
                handleTypeChange('å£²ä¸Šãƒ»æ³¨æ–‡'); 
                
                // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆå¾Œã€å…¨ã¦ã®å…¥åŠ›ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã«æˆ»ã™
                AppData.orders.forEach(order => toggleQtyInput(order.key, false));
                AppData.expenseDefs.forEach(def => toggleExpenseInputs(def.key, false));

            } catch (error) {
                console.error('Fetch Error:', error);
                
                const fetchMessage = error.message.includes('Failed to fetch') 
                    ? `ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚URL: ${GAS_API_URL}` 
                    : error.message;

                resultDiv.textContent = 'âŒ è¨˜éŒ²å¤±æ•—: ' + fetchMessage;
                resultDiv.className = 'mt-4 p-4 text-sm font-medium rounded-lg text-center bg-red-900 text-red-300';
            }
        }
        
        /**
         * åˆ†æãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç† 
         */
        async function attemptRedirect() {
            const GAS_API_URL = getGasApiUrl(); // URLã‚’å–å¾—
            const q7Input = document.getElementById('q7');
            const q7Value = q7Input.value.trim();
            const redirectResultDiv = document.getElementById('redirect-result');
            redirectResultDiv.textContent = ''; 

            if (!q7Value) {
                redirectResultDiv.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                return;
            }
            
            if (q7Value === AppData.setVal) {
                redirectResultDiv.textContent = 'âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼æˆåŠŸï¼åˆ†æãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™...';
                redirectResultDiv.className = 'text-green-400 text-sm';
                
                window.open(GAS_API_URL + "?page=redirect", '_blank');

            } else {
                redirectResultDiv.textContent = 'âŒ å…¥åŠ›å†…å®¹ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚';
                redirectResultDiv.className = 'text-red-400 text-sm';
            }
        }

    </script>
</body>
</html>