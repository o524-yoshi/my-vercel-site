<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CabaTech å£²ä¸Šãƒ»çµŒè²»ç®¡ç†ãƒ„ãƒ¼ãƒ«ï¼ˆãƒ‡ãƒ¢ç‰ˆï¼‰</title>
    <!-- Tailwind CSS CDNã‚’ãƒ­ãƒ¼ãƒ‰ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        body { font-family: 'Inter', sans-serif; }
        .form-section {
            @apply p-4 bg-gray-700 rounded-lg shadow-inner;
        }
        .section-header {
            @apply text-lg font-semibold text-teal-400 border-b border-gray-600 pb-2 mb-3;
        }
        
        /* ğŸ’¡ å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« - !importantã§æ–‡å­—è‰²ã‚’å¼·åˆ¶ (teal-400) */
        .input-style {
            @apply w-full p-2 border border-gray-600 bg-gray-800 rounded-md 
                   placeholder-gray-500 
                   focus:ring-teal-500 focus:border-teal-500 
                   transition duration-150 disabled:opacity-70;
            
            /* text-teal-400 (#2dd4bf) ã®ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’!importantã§å¼·åˆ¶é©ç”¨ */
            color: #2dd4bf !important;
        }
        
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 sm:p-8 flex flex-col items-center">

    <div class="w-full max-w-lg bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl space-y-6">
        <h2 class="text-3xl font-extrabold text-center text-teal-400">CabaTech å£²ä¸Šãƒ»çµŒè²»ç®¡ç†ãƒ„ãƒ¼ãƒ«</h2>

        <!-- æœ€çµ‚æ›´æ–°æ—¥æ™‚ - ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®é™çš„æ—¥ä»˜ã§è¡¨ç¤º -->
        <div id="last-updated" class="text-xs text-gray-500 text-right">æœ€çµ‚æ›´æ–°: 2025/12/02 15:53:40</div>
        
        <!-- ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠ -->
        <form id="main-form" class="space-y-6">
            
            <!-- 1. ã‚«ãƒ†ã‚´ãƒªé¸æŠ (type) -->
            <div id="type-section" class="form-section space-y-3">
                <p class="text-sm font-medium text-gray-400">è¨˜éŒ²ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ (type):</p>
                <div class="flex space-x-4">
                    <label class="flex items-center text-gray-400 cursor-pointer p-2 rounded-lg hover:bg-gray-600 transition">
                        <input type="radio" name="type" value="å£²ä¸Šãƒ»æ³¨æ–‡" 
                               class="text-teal-500 focus:ring-teal-500 h-4 w-4 border-gray-300" 
                               onchange="handleTypeChange(this.value)" checked>
                        <span class="ml-2 text-sm font-medium">å£²ä¸Šãƒ»æ³¨æ–‡</span>
                    </label>
                    <label class="flex items-center text-gray-400 cursor-pointer p-2 rounded-lg hover:bg-gray-600 transition">
                        <input type="radio" name="type" value="çµŒè²»" 
                               class="text-teal-500 focus:ring-teal-500 h-4 w-4 border-gray-300" 
                               onchange="handleTypeChange(this.value)">
                        <span class="ml-2 text-sm font-medium">çµŒè²»</span>
                    </label>
                </div>
            </div>

            <!-- 2. æ‹…å½“è€…/ã‚­ãƒ£ã‚¹ãƒˆåå…¥åŠ› (q2) -->
            <div id="q2-section" class="form-section space-y-1">
                <label for="q2" class="block text-sm font-medium text-gray-400">æ‹…å½“è€…å (q2): <span class="text-red-400">*</span></label>
                <!-- input-style é©ç”¨ -->
                <input type="text" id="q2" name="q2" class="input-style" placeholder="ä¾‹: å¤ªéƒ">
            </div>

            <!-- 3. å£²ä¸Šãƒ»æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ  (q3) - åˆæœŸè¡¨ç¤º -->
            <div id="q3-section" class="form-section space-y-3">
                <h3 class="section-header">å£²ä¸Šãƒ»æ³¨æ–‡é …ç›® (q3)</h3>
                <div id="sales-items-container" class="space-y-3">
                    <p class="text-sm text-gray-400">æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...</p>
                </div>
            </div>

            <!-- 4. çµŒè²»ãƒ•ã‚©ãƒ¼ãƒ  (q5) - åˆæœŸéè¡¨ç¤º -->
            <div id="q5-section" class="form-section space-y-3 hidden">
                <h3 class="section-header">çµŒè²»é …ç›® (q5)</h3>
                <div id="expense-items-container" class="space-y-4">
                    <!-- çµŒè²»é …ç›®ãŒã“ã“ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¾ã™ -->
                </div>
                
                <!-- çµŒè²»è©³ç´°å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                <div id="expense-details-container" class="form-section space-y-3 mt-4">
                    <p class="text-sm font-medium text-gray-400 border-b border-gray-600 pb-1">è©³ç´°å…¥åŠ›:</p>
                    <div id="detail-inputs-area" class="space-y-2">
                        <!-- è©³ç´°å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã“ã“ã«å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
                        <p class="text-xs text-gray-500">é …ç›®ã‚’é¸æŠã™ã‚‹ã¨ã€å¿…è¦ãªè©³ç´°å…¥åŠ›ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                    </div>
                </div>
            </div>
            
            <!-- 5. é€ä¿¡ãƒœã‚¿ãƒ³ -->
            <button type="submit"
                    class="w-full py-3 bg-teal-600 hover:bg-teal-500 text-white font-semibold rounded-lg shadow-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50 transform hover:scale-[1.01]">
                ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡ãƒ»è¨˜éŒ²
            </button>
        </form>

        <!-- 6. åˆ†æãƒšãƒ¼ã‚¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ (q7) -->
        <div class="form-section space-y-3 border-t border-gray-700 pt-4">
            <h3 class="text-base font-bold text-gray-400">åˆ†æãƒšãƒ¼ã‚¸ã¸ç§»å‹• (q7)</h3>
            <p class="text-xs text-gray-400">ã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            <div class="flex space-x-3">
                <!-- input-style é©ç”¨ -->
                <input type="password" id="q7" name="q7" class="input-style flex-grow" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                <button onclick="attemptRedirect()"
                        class="py-2 px-4 bg-orange-600 hover:bg-orange-500 text-white text-sm font-medium rounded-md transition duration-200 focus:outline-none focus:ring-2 focus:ring-orange-500">
                    åˆ†æãƒšãƒ¼ã‚¸ã¸
                </button>
            </div>
            <div id="redirect-result" class="text-xs text-red-400 min-h-4"></div>
        </div>

        <!-- 7. ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡çµæœ -->
        <div id="result" class="mt-4 p-4 text-sm font-medium rounded-lg text-center min-h-10 transition duration-300 text-teal-500">
            <!-- çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
    </div>

    <script>
        // ğŸ’¡ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰æä¾›ã•ã‚ŒãŸæ­£ã—ã„URL
        const CORRECT_GAS_API_URL = "https://script.google.com/macros/s/AKfycbwm1cN_jcDzR3YJLVnf6kCYCMGrHuKJ6-NYjV6rUR2GX_DBcaLFcICjebVdRN9f7Hu1_A/exec"; 
        
        /**
         * ç¾åœ¨ä½¿ç”¨ã™ã¹ãGASã®URLã‚’å–å¾—ã™ã‚‹
         */
        function getGasApiUrl() {
            return CORRECT_GAS_API_URL;
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ (ãƒ•ãƒ©ãƒƒãƒˆæ§‹é€ ã«æˆ»ã™)
        let AppData = {
            orders: [], // å£²ä¸Šé …ç›®: { key, price, qty }
            expenseDefs: [], // çµŒè²»å®šç¾©: { parent, child, cols: ['col2:æ™‚çµ¦ (text)', 'col3:æ™‚é–“ (number)', ...] }
            setVal: '' // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
        };
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸå‡¦ç†
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('main-form').addEventListener('submit', (e) => {
                e.preventDefault();
                submitFormData();
            });
            
            loadAllData();
        });


        /**
         * GASã‹ã‚‰å…¨ã¦ã®ãƒ•ã‚©ãƒ¼ãƒ å®šç¾©ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆçš„ã«å–å¾—ã™ã‚‹
         */
        async function loadAllData() {
            const GAS_API_URL = getGasApiUrl();
            const salesContainer = document.getElementById('sales-items-container');
            const resultDiv = document.getElementById('result');

            salesContainer.innerHTML = '<p class="text-sm text-gray-400">æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...</p>';
            resultDiv.className = 'hidden';

            try {
                const response = await fetch(GAS_API_URL + "?action=loadData");
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const responseText = await response.text();
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error('JSON Parse failed:', responseText);
                    throw new Error('GASã‹ã‚‰è¿”ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒJSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
                }

                if (data.status === 'success') {
                    // ğŸ’¡ ãƒ‡ãƒãƒƒã‚°ç”¨: å—ä¿¡ã—ãŸç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
                    console.log("ğŸ” GASã‹ã‚‰å—ä¿¡ã—ãŸç”Ÿãƒ‡ãƒ¼ã‚¿ (orders):", data.orders);
                    console.log("ğŸ” GASã‹ã‚‰å—ä¿¡ã—ãŸç”Ÿãƒ‡ãƒ¼ã‚¿ (expenseDefs):", data.expenseDefs);

                    // æˆåŠŸã—ãŸå ´åˆã€AppDataã‚’GASãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ã
                    AppData.orders = (data.orders || []).filter(item => item && item.key);
                    AppData.setVal = data.setVal || '';
                    
                    // ğŸ’¡ ã€ä¿®æ­£æ¸ˆã¿ã€‘GASã‹ã‚‰å—ä¿¡ã—ãŸãƒ•ãƒ©ãƒƒãƒˆãªçµŒè²»ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®AppData.expenseDefså½¢å¼ã«å¤‰æ›ã™ã‚‹
                    let flattenedDefs = [];
                    if (data.expenseDefs && Array.isArray(data.expenseDefs)) {
                        data.expenseDefs.forEach(def => { // def ã¯ {parentKey, childKey, details} ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
                            const parentKey = def.parentKey || '';
                            const childKey = def.childKey || '';
                            
                            if (parentKey && childKey) {
                                // details ã¯ {header, type, name} ã®é…åˆ—
                                const validDetails = (def.details || []).filter(detail => {
                                    // nameãŒå­˜åœ¨ã—ã€ç©ºæ–‡å­—åˆ—ã§ãªã‘ã‚Œã°æœ‰åŠ¹ã¨ã¿ãªã™
                                    const name = String(detail.name || '').trim();
                                    return detail && (name !== '' && name !== '-'); 
                                });

                                // colsé…åˆ—ã‚’æ§‹ç¯‰ã™ã‚‹ (ä¾‹: "col2:æ™‚çµ¦ (text)")
                                const cols = validDetails.map(detail => {
                                    const colName = String(detail.name).trim(); // col2, col3, col4ã®ã‚­ãƒ¼åãŒå…¥ã‚‹
                                    if (colName === '' || colName === '-') {
                                        return null; 
                                    }
                                    
                                    // headerãŒç©ºã®å ´åˆã¯ colName ã‚’ä½¿ç”¨
                                    const header = (detail.header && String(detail.header).trim() !== '') ? detail.header : colName; 
                                    // typeãŒç©ºã®å ´åˆã¯ 'text' ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã™ã‚‹
                                    const typeLower = (detail.type || '').toLowerCase();
                                    const typeSuffix = typeLower === 'number' ? '(number)' : '(text)';

                                    // colName:header typeSuffix ã®å½¢å¼ã§çµåˆ (ä¾‹: col2:æ™‚çµ¦ (text))
                                    return `${colName}:${header} ${typeSuffix}`;
                                }).filter(col => col !== null);

                                // æœ‰åŠ¹ãªè©³ç´°å®šç¾©ãŒå­˜åœ¨ã™ã‚‹ã‹ã©ã†ã‹ã«é–¢ã‚ã‚‰ãšã€é …ç›®è‡ªä½“ã¯è¿½åŠ 
                                flattenedDefs.push({
                                    parent: parentKey,
                                    child: childKey,
                                    cols: cols
                                });
                            }
                        });
                    }

                    // å¤‰æ›å¾Œã®ãƒ•ãƒ©ãƒƒãƒˆãªçµŒè²»å®šç¾©ã‚’ã‚»ãƒƒãƒˆ
                    AppData.expenseDefs = flattenedDefs;
                    console.log("âœ… GASã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’æ­£å¸¸ã«ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚");
                    console.log("ğŸ’¡ å¤‰æ›å¾Œã®ãƒ•ãƒ©ãƒƒãƒˆãªçµŒè²»ãƒ‡ãƒ¼ã‚¿ (AppData.expenseDefs):", AppData.expenseDefs);


                    // ğŸ’¡ çµŒè²»ãƒ‡ãƒ¼ã‚¿ãŒç©ºã ã£ãŸå ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                    if (AppData.expenseDefs.length === 0 && AppData.orders.length > 0) {
                        // ordersã®ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¦ã„ã‚Œã°ã€GASã¨ã®æ¥ç¶šè‡ªä½“ã¯æˆåŠŸã—ã¦ã„ã‚‹ãŸã‚ã€å®šç¾©ã®å•é¡Œã ã¨æ–­å®šã§ãã‚‹
                        resultDiv.textContent = 'âš ï¸ çµŒè²»é …ç›®ãŒä¸€ã¤ã‚‚å®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã€ŒçµŒè²»å®šç¾©ã€ã‚·ãƒ¼ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
                        resultDiv.className = 'mt-4 p-4 text-sm font-medium rounded-lg text-center bg-yellow-900 text-yellow-300';
                    } else if (AppData.expenseDefs.length === 0 && AppData.orders.length === 0) {
                        // å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå–ã‚Œã¦ã„ãªã„å ´åˆï¼ˆæ¥ç¶šã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ã‚‚å«ã‚€ãŒã€ä»Šå›ã¯GASã«æ¥ç¶šã§ãã¦ã„ã‚‹å‰æï¼‰
                         resultDiv.textContent = 'âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒä¸€ã¤ã‚‚å®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã€ŒçµŒè²»å®šç¾©ã€ã¨ã€Œå£²ä¸Šãƒ»æ³¨æ–‡å®šç¾©ã€ã‚·ãƒ¼ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
                        resultDiv.className = 'mt-4 p-4 text-sm font-medium rounded-lg text-center bg-yellow-900 text-yellow-300';
                    } else {
                        resultDiv.className = 'hidden'; 
                    }

                } else {
                    throw new Error(`GASã‚¨ãƒ©ãƒ¼: ${data.message || 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'}`);
                }
            } catch (error) {
                console.error('âš ï¸ GASã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™:', error);
                
                // --- ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å¼·åˆ¶çš„ã«è¨­å®šã™ã‚‹ ---
                AppData.orders = [
                    { key: 'ãƒ“ãƒ¼ãƒ« (å¤§)', price: 800, qty: 1 },
                    { key: 'ãƒœãƒˆãƒ« (èµ¤)', price: 5000, qty: 1 },
                    { key: 'ã‚·ãƒ§ãƒƒãƒˆ', price: 1000, qty: 3 },
                    { key: 'ãƒ•ãƒ¼ãƒ‰', price: 1500, qty: 1 }
                ];
                
                // ä»¥å‰ã®ãƒ•ãƒ©ãƒƒãƒˆãªçµŒè²»æ§‹æˆã«æˆ»ã™
                AppData.expenseDefs = [
                    { parent: 'ä¼šè­°è²»', child: 'é£²é£Ÿä»£', cols: ['col2:ä¼šè­°ç›®çš„ (text)', 'col3:å‚åŠ äººæ•° (number)', 'col4:åˆè¨ˆé‡‘é¡ (number)'] },
                    { parent: 'ä¼šè­°è²»', child: 'ä¼šå ´è²»', cols: ['col2:ä¼šå ´å (text)', 'col3:åˆ©ç”¨æ™‚é–“ (number)', 'col4:åˆè¨ˆé‡‘é¡ (number)'] },
                    { parent: 'æ¶ˆè€—å“è²»', child: 'å‚™å“è³¼å…¥', cols: ['col2:å“ç›® (text)', 'col3:é‡‘é¡ (number)'] },
                    { parent: 'æ¶ˆè€—å“è²»', child: 'åº—èˆ—ç”¨å“', cols: ['col2:è©³ç´° (text)', 'col3:æ•°é‡ (number)', 'col4:å˜ä¾¡ (number)'] },
                    { parent: 'äº¤é€šè²»', child: 'ã‚¿ã‚¯ã‚·ãƒ¼', cols: ['col2:è¡Œå…ˆ (text)', 'col3:é‡‘é¡ (number)'] },
                    { parent: 'äº¤é€šè²»', child: 'é›»è»Šãƒ»ãƒã‚¹', cols: ['col2:åŒºé–“ (text)', 'col3:é‡‘é¡ (number)'] }
                ];
                AppData.setVal = 'cabatech_pass';
                // ------------------------------------------

                resultDiv.textContent = `âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ${error.message}ã€‚ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã§å®Ÿè¡Œä¸­ã€‚`;
                resultDiv.className = 'mt-4 p-4 text-sm font-medium rounded-lg text-center bg-red-900 text-red-300';
            }

            // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            renderSalesItems();
            renderExpenseItems(); // ãƒ•ãƒ©ãƒƒãƒˆæ§‹é€ ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            handleTypeChange('å£²ä¸Šãƒ»æ³¨æ–‡'); // åˆæœŸã‚«ãƒ†ã‚´ãƒªã®è¡¨ç¤º
        }

        /**
         * å£²ä¸Šãƒ»æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ  (q3) ã‚’å‹•çš„ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
         */
        function renderSalesItems() {
            const container = document.getElementById('sales-items-container');
            if (AppData.orders.length === 0) {
                container.innerHTML = '<p class="text-sm text-yellow-400">æ³¨æ–‡é …ç›®ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã€Œå£²ä¸Šãƒ»æ³¨æ–‡å®šç¾©ã€ã‚·ãƒ¼ãƒˆã«ã”è¨˜å…¥ãã ã•ã„ã€‚</p>';
                return;
            }

            const itemsHtml = AppData.orders.map(order => `
                <div class="flex items-center space-x-3 p-2 bg-gray-600 rounded-md">
                    <!-- ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ (q3) -->
                    <label class="flex items-center flex-grow text-sm text-gray-300 cursor-pointer">
                        <input type="checkbox" name="q3" value="${order.key}" 
                               class="text-teal-500 focus:ring-teal-500 h-4 w-4 border-gray-400 rounded"
                               onchange="toggleQtyInput('${order.key}', this.checked)">
                        <span class="ml-2 font-medium">${order.key} (${new Intl.NumberFormat('ja-JP').format(order.price)}å††)</span>
                    </label>
                    
                    <!-- æ•°é‡å…¥åŠ› (q3_qty_...) -->
                    <!-- input-style ã‚’é©ç”¨ -->
                    <input type="number" 
                           id="q3_qty_${order.key}" 
                           name="q3_qty_${order.key}" 
                           value="${order.qty}" 
                           min="0" 
                           placeholder="æ•°é‡" 
                           class="input-style w-20 p-1 text-sm text-center border border-gray-500 bg-gray-700 rounded-md disabled:opacity-70">
                </div>
            `).join('');

            container.innerHTML = `
                <p class="text-xs text-gray-400 mb-2">ãƒã‚§ãƒƒã‚¯ã—ãŸé …ç›®ã‚’å£²ä¸Šã¨ã—ã¦è¨˜éŒ²ã—ã¾ã™ã€‚</p>
                <input type="hidden" name="q3" value=""> <!-- é¸æŠãŒãªã„å ´åˆã«å‚™ãˆãŸãƒ€ãƒŸãƒ¼ -->
                ${itemsHtml}
            `;
            
            // ãƒ­ãƒ¼ãƒ‰å¾Œã€å…¨ã¦ã®æ•°é‡å…¥åŠ›ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã«æˆ»ã™
            AppData.orders.forEach(order => toggleQtyInput(order.key, false));
        }
        
        /**
         * q3ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«å¿œã˜ã¦æ•°é‡å…¥åŠ›ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
         */
        function toggleQtyInput(key, isChecked) {
            const qtyInput = document.getElementById(`q3_qty_${key}`);
            if (qtyInput) {
                qtyInput.disabled = !isChecked;
                if (isChecked) {
                   qtyInput.value = AppData.orders.find(o => o.key === key)?.qty || 1;
                } else {
                   qtyInput.value = 0;
                }
            }
        }


        /**
         * çµŒè²»ã‚¢ã‚¤ãƒ†ãƒ  (q5) ã‚’å‹•çš„ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ (ãƒ•ãƒ©ãƒƒãƒˆæ§‹é€ ã«æˆ»ã™)
         */
        function renderExpenseItems() {
            const container = document.getElementById('expense-items-container');
            
            if (AppData.expenseDefs.length === 0) {
                container.innerHTML = '<p class="text-sm text-yellow-400">çµŒè²»é …ç›®ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
                return;
            }

            // parentKeyãŒundefinedã«ãªã‚‹ã®ã‚’é˜²ããŸã‚ã€ç©ºæ–‡å­—åˆ—ã«å¤‰æ›ã—ã¦ã‹ã‚‰ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚­ãƒ¼ã‚’å–å¾—
            const parentKeys = [...new Set(AppData.expenseDefs.map(def => def.parent || ''))].filter(k => k);

            const itemsHtml = parentKeys.map(parentKey => {
                const childDefs = AppData.expenseDefs.filter(def => def.parent === parentKey);

                // è¦ªã‚«ãƒ†ã‚´ãƒªã”ã¨ã®ã‚°ãƒ«ãƒ¼ãƒ—
                const parentGroup = `
                    <div class="space-y-2 p-3 border border-gray-600 rounded-lg bg-gray-700">
                        <p class="text-base font-bold text-teal-400">${parentKey}</p>
                        <div class="space-y-1 pl-4 border-l-2 border-teal-700">
                            ${childDefs.map(def => {
                                // å­ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³
                                const safeChildKey = String(def.child || '');
                                const safeParentKey = String(parentKey); 
                                
                                // IDç”Ÿæˆæ™‚ã«replaceã‚’å®‰å…¨ã«å®Ÿè¡Œ
                                const radioId = `q5_${safeParentKey.replace(/\s/g, '_')}_${safeChildKey.replace(/\s/g, '_')}`;
                                
                                return `
                                    <label class="flex items-center text-sm font-medium text-gray-300 cursor-pointer">
                                        <input type="radio" 
                                               name="q5_selection" 
                                               id="${radioId}"
                                               value="${parentKey}|${def.child}" 
                                               class="text-orange-500 focus:ring-orange-500 h-4 w-4 border-gray-400"
                                               onchange="handleExpenseSelection('${parentKey}', '${def.child}')">
                                        <span class="ml-2">${def.child}</span>
                                    </label>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
                return parentGroup;
            }).join('');

            container.innerHTML = `
                <p class="text-xs text-gray-400 mb-2">è¨˜éŒ²ã—ãŸã„çµŒè²»ã®é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
                <input type="hidden" name="q5_selection" value=""> 
                ${itemsHtml}
            `;
            
            // åˆæœŸè¡¨ç¤ºã§è©³ç´°å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('detail-inputs-area').innerHTML = '<p class="text-xs text-gray-500">é …ç›®ã‚’é¸æŠã™ã‚‹ã¨ã€å¿…è¦ãªè©³ç´°å…¥åŠ›ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>';
        }
        
        /**
         * çµŒè²»é¸æŠæ™‚ã®è©³ç´°å…¥åŠ›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å‡¦ç† (ãƒ•ãƒ©ãƒƒãƒˆæ§‹é€ ã«æˆ»ã™)
         */
        function handleExpenseSelection(parentKey, childKey) {
            const detailArea = document.getElementById('detail-inputs-area');
            detailArea.innerHTML = '';
            
            // é¸æŠã•ã‚ŒãŸé …ç›®å®šç¾©ã‚’è¦‹ã¤ã‘ã‚‹
            const selectedDef = AppData.expenseDefs.find(def => def.parent === parentKey && def.child === childKey);
            
            if (!selectedDef || !selectedDef.cols || selectedDef.cols.length === 0) {
                // colsãŒç©ºã®å ´åˆã¯ã€è©³ç´°å…¥åŠ›ã¯ä¸è¦ã ãŒã€ã‚¨ãƒ©ãƒ¼ã¨ã¯ã—ãªã„
                detailArea.innerHTML = '<p class="text-xs text-gray-500">ã“ã®é …ç›®ã«ã¯è¿½åŠ ã®è©³ç´°å…¥åŠ›ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            // colsé…åˆ—ã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç”Ÿæˆ
            const inputsHtml = selectedDef.cols.map(colDef => {
                // colDefã®å½¢å¼: "col2:ä¼šè­°ç›®çš„ (text)"
                const parts = colDef.split(':');
                if (parts.length < 2) {
                    console.warn('Skipping invalid column definition:', colDef);
                    return ''; // ç„¡åŠ¹ãªå®šç¾©ã¯ã‚¹ã‚­ãƒƒãƒ—
                }
                
                const [keyType, ...rest] = parts;
                const colKey = keyType.trim().split(' ')[0]; 
                const header = rest.join(':').trim(); // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†
                
                // typeãŒ(number)ã®å ´åˆã¯number
                const inputType = header.includes('(number)') ? 'number' : 'text';
                // ãƒ˜ãƒƒãƒ€ãƒ¼åã‹ã‚‰ (text) ã‚„ (number) ã‚’é™¤å»
                const cleanHeader = header.replace(/\s\(text\)|\s\(number\)/, '');
                
                // colKeyã¯ 'col2', 'col3', 'col4' ã®ã„ãšã‚Œã‹
                return `
                    <div>
                        <label for="${colKey}" class="block text-sm font-medium text-gray-400">${cleanHeader}:</label>
                        <!-- input-style ã‚’é©ç”¨ã—ã€!importantã§è‰²ã‚’ä¿è¨¼ -->
                        <input type="${inputType}" 
                               id="${colKey}" 
                               name="${colKey}" 
                               class="input-style" 
                               placeholder="${cleanHeader}">
                    </div>
                `;
            }).join('');

            detailArea.innerHTML = inputsHtml;
        }


        /**
         * ã‚¿ã‚¤ãƒ— (å£²ä¸Šãƒ»çµŒè²») ã®é¸æŠã«å¿œã˜ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
         */
        function handleTypeChange(type) {
            const q3Section = document.getElementById('q3-section');
            const q5Section = document.getElementById('q5-section');

            if (type === 'å£²ä¸Šãƒ»æ³¨æ–‡') {
                q3Section.classList.remove('hidden');
                q5Section.classList.add('hidden');
            } else if (type === 'çµŒè²»') {
                q3Section.classList.add('hidden');
                q5Section.classList.remove('hidden');
                
                // çµŒè²»ãƒ•ã‚©ãƒ¼ãƒ ã«åˆ‡ã‚Šæ›¿ãˆãŸéš›ã€ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ãƒã‚§ãƒƒã‚¯ã¨è©³ç´°å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
                document.getElementsByName('q5_selection').forEach(radio => radio.checked = false);
                document.getElementById('detail-inputs-area').innerHTML = '<p class="text-xs text-gray-500">é …ç›®ã‚’é¸æŠã™ã‚‹ã¨ã€å¿…è¦ãªè©³ç´°å…¥åŠ›ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>';
            }
        }


        /**
         * ãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿é€ä¿¡å‡¦ç† (GASã®submitFormã‚’å©ã)
         */
        async function submitFormData() {
            const GAS_API_URL = getGasApiUrl();
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'mt-4 p-4 text-sm font-medium rounded-lg text-center bg-gray-700 text-teal-500';
            resultDiv.textContent = 'é€ä¿¡ä¸­...';

            const form = document.getElementById('main-form');
            const formData = new FormData();
            
            // å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯
            const type = document.querySelector('input[name="type"]:checked')?.value;
            const q2Value = document.getElementById('q2').value.trim();
            const q5Selection = document.querySelector('input[name="q5_selection"]:checked')?.value;

            if (!q2Value) {
                resultDiv.textContent = 'âŒ æ‹…å½“è€…å (q2) ã¯å¿…é ˆã§ã™ã€‚';
                resultDiv.className = 'mt-4 p-4 text-sm font-medium rounded-lg text-center bg-red-900 text-red-300';
                document.getElementById('q2').focus();
                return;
            }
            
            if (type === 'çµŒè²»' && !q5Selection) {
                resultDiv.textContent = 'âŒ çµŒè²»ã‚’è¨˜éŒ²ã™ã‚‹ã«ã¯é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
                resultDiv.className = 'mt-4 p-4 text-sm font-medium rounded-lg text-center bg-red-900 text-red-300';
                return;
            }
            
            formData.append('id', 'anonymous_user');
            formData.append('pass', 'none');
            
            formData.append('type', 'write'); 
            formData.append('category', type); 
            formData.append('q2', q2Value);
            
            // å£²ä¸Šé …ç›®ã®åé›†
            if (type === 'å£²ä¸Šãƒ»æ³¨æ–‡') {
                let hasSalesItem = false;
                form.querySelectorAll('input[name="q3"]:checked').forEach(checkbox => {
                    const key = checkbox.value;
                    const qtyInput = document.getElementById(`q3_qty_${key}`);
                    if (qtyInput && !qtyInput.disabled && parseInt(qtyInput.value) > 0) {
                         // GASå´ã§ã¾ã¨ã‚ã¦å‡¦ç†ã§ãã‚‹ã‚ˆã†ã€å£²ä¸Šé …ç›®ã®ã‚­ãƒ¼ã¨æ•°é‡ã‚’é…åˆ—ã¨ã—ã¦æ¸¡ã™
                        formData.append('q3_item', key); 
                        formData.append('q3_qty', qtyInput.value); 
                        hasSalesItem = true;
                    }
                });
                
                // å£²ä¸Šãƒ»æ³¨æ–‡é¸æŠæ™‚ã«ä½•ã‚‚ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„ã€ã¾ãŸã¯æ•°é‡ãŒ0ã®å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
                if (!hasSalesItem && AppData.orders.length > 0) { // ordersãŒã‚ã‚‹å ´åˆã®ã¿ãƒã‚§ãƒƒã‚¯
                    resultDiv.textContent = 'âŒ å£²ä¸Šãƒ»æ³¨æ–‡é …ç›®ã‚’1ã¤ä»¥ä¸Šã€æ•°é‡1ä»¥ä¸Šã§ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚';
                    resultDiv.className = 'mt-4 p-4 text-sm font-medium rounded-lg text-center bg-red-900 text-red-300';
                    return;
                } else if (AppData.orders.length === 0) {
                    resultDiv.textContent = 'âŒ å£²ä¸Šé …ç›®ãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ã“ã®ãƒ•ã‚©ãƒ¼ãƒ ã§ã¯çµŒè²»ã—ã‹è¨˜éŒ²ã§ãã¾ã›ã‚“ã€‚';
                    resultDiv.className = 'mt-4 p-4 text-sm font-medium rounded-lg text-center bg-red-900 text-red-300';
                    return;
                }
            }

            // çµŒè²»é …ç›®ã®åé›† (ãƒ•ãƒ©ãƒƒãƒˆæ§‹é€ )
            if (type === 'çµŒè²»' && q5Selection) {
                const [parentKey, childKey] = q5Selection.split('|');
                
                formData.append('q5_parent_key', parentKey); // è¦ªã‚«ãƒ†ã‚´ãƒª (GASã®é …ç›®å)
                formData.append('q5_child_key', childKey); // å­ã‚«ãƒ†ã‚´ãƒª (GASã®åŒºåˆ†)
                
                // è©³ç´°å…¥åŠ› (col2, col3, col4) ã®å€¤ã‚’åé›†
                const detailInputContainer = document.getElementById('detail-inputs-area');
                if (detailInputContainer) {
                    let hasMissingNumberInput = false;
                    detailInputContainer.querySelectorAll('input').forEach(input => {
                        if (input.name) {
                            
                            // æ•°å€¤å…¥åŠ›ãŒç©ºã®å ´åˆã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                            if (input.type === 'number' && input.value.trim() === '') {
                                hasMissingNumberInput = true;
                            }
                            
                             // input.name ã¯ 'col2', 'col3', 'col4' ã®ã„ãšã‚Œã‹
                            formData.append(input.name, input.value);
                        }
                    });
                    
                    if (hasMissingNumberInput) {
                        resultDiv.textContent = 'âŒ é‡‘é¡ã‚„æ•°é‡ãªã©ã®æ•°å€¤é …ç›®ã¯ç©ºã«ã§ãã¾ã›ã‚“ã€‚0ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                        resultDiv.className = 'mt-4 p-4 text-sm font-medium rounded-lg text-center bg-red-900 text-red-300';
                        return;
                    }
                }
            }
            
            // æœ€çµ‚é€ä¿¡
            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const responseText = await response.text();
                let data;

                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error('JSON Parse failed:', responseText);
                    throw new Error('JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: å—ä¿¡ãƒ‡ãƒ¼ã‚¿ãŒJSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
                }
                
                if (data.status === 'success') {
                    resultDiv.textContent = 'âœ… è¨˜éŒ²æˆåŠŸï¼ãƒ‡ãƒ¼ã‚¿ã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«é€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚';
                    resultDiv.className = 'mt-4 p-4 text-sm font-medium rounded-lg text-center bg-green-900 text-green-300';
                } else {
                    throw new Error(`GASã‚¨ãƒ©ãƒ¼: ${data.message || 'è¨˜éŒ²å¤±æ•—ã€‚'}`);
                }
                
                // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
                form.reset();
                handleTypeChange('å£²ä¸Šãƒ»æ³¨æ–‡'); 
                
                // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆå¾Œã€å…¨ã¦ã®å…¥åŠ›ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã«æˆ»ã™
                AppData.orders.forEach(order => toggleQtyInput(order.key, false));
                document.getElementById('detail-inputs-area').innerHTML = '<p class="text-xs text-gray-500">é …ç›®ã‚’é¸æŠã™ã‚‹ã¨ã€å¿…è¦ãªè©³ç´°å…¥åŠ›ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>';

            } catch (error) {
                console.error('Fetch Error:', error);
                
                const fetchMessage = error.message.includes('Failed to fetch') 
                    ? `ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚URL: ${GAS_API_URL}` 
                    : error.message;

                resultDiv.textContent = 'âŒ è¨˜éŒ²å¤±æ•—: ' + fetchMessage;
                resultDiv.className = 'mt-4 p-4 text-sm font-medium rounded-lg text-center bg-red-900 text-red-300';
            }
        }
        
        /**
         * åˆ†æãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç† 
         */
        async function attemptRedirect() {
            const GAS_API_URL = getGasApiUrl();
            const q7Input = document.getElementById('q7');
            const q7Value = q7Input.value.trim();
            const redirectResultDiv = document.getElementById('redirect-result');
            redirectResultDiv.textContent = ''; 

            if (!q7Value) {
                redirectResultDiv.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                return;
            }
            
            if (q7Value === AppData.setVal) {
                redirectResultDiv.textContent = 'âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼æˆåŠŸï¼åˆ†æãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™...';
                redirectResultDiv.className = 'text-green-400 text-sm';
                
                window.open(GAS_API_URL + "?page=redirect", '_blank');

            } else {
                redirectResultDiv.textContent = 'âŒ å…¥åŠ›å†…å®¹ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚';
                redirectResultDiv.className = 'text-red-400 text-sm';
            }
        }

    </script>
</body>
</html>